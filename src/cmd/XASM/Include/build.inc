#ifndef US_BUILD
#define US_BUILD

#include "node.inc"

inline bool addInst(Node *r, const std::vector<uint8_t> &opcode, const std::string &mnemo, int immSize)
{
	Node *current = r;

	for(size_t i = 0; i < opcode.size(); i++)
	{
		uint8_t byte = opcode[i];

		if(current->children.find(byte) == current->children.end())
		{
			current->children[byte] = new Node();
			current->children[byte]->opcode = std::vector<uint8_t>(opcode.begin(), opcode.begin() + i + 1);
		}

		current = current->children[byte];
	}

	current->is_term = true;
	current->mnemo = mnemo;
	current->immSize = immSize;

	return true;
}

inline bool buildTree(Node *r)
{
	// NOP
	addInst(r, {0x00}, "NOP", 0);

	// INC系
	addInst(r, {0x01, 0x00, 0x00}, "INC EAX", 0);
	addInst(r, {0x01, 0x00, 0x01}, "INC EBX", 0);
	addInst(r, {0x01, 0x00, 0x02}, "INC [EBX]", 0);
	addInst(r, {0x01, 0x00, 0x03}, "INC ECX", 0);
	addInst(r, {0x01, 0x00, 0x04}, "INC EDX", 0);
	addInst(r, {0x01, 0x00, 0x05}, "INC EEX", 0);
	addInst(r, {0x01, 0x00, 0x06}, "INC EDI", 0);

	// ADD系
	// ADD EAX, ...
	addInst(r, {0x01, 0x01, 0x00, 0x00}, "ADD EAX, IMM", 4);
	addInst(r, {0x01, 0x01, 0x00, 0x01}, "ADD EAX, EBX", 0);
	addInst(r, {0x01, 0x01, 0x00, 0x02}, "ADD EAX, ECX", 0);
	addInst(r, {0x01, 0x01, 0x00, 0x03}, "ADD EAX, EDX", 0);
	addInst(r, {0x01, 0x01, 0x00, 0x04}, "ADD EAX, EEX", 0);

	// ADD EBX, ...
	addInst(r, {0x01, 0x01, 0x01, 0x00}, "ADD EBX, IMM", 4);
	addInst(r, {0x01, 0x01, 0x01, 0x01}, "ADD EBX, EAX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x02}, "ADD EBX, ECX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x03}, "ADD EBX, EDX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x04}, "ADD EBX, EEX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x05}, "ADD [EBX], IMM", 4);
	addInst(r, {0x01, 0x01, 0x01, 0x06}, "ADD [EBX], EAX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x07}, "ADD [EBX], ECX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x08}, "ADD [EBX], EDX", 0);
	addInst(r, {0x01, 0x01, 0x01, 0x09}, "ADD [EBX], EEX", 0);

	// ADD ECX, ...
	addInst(r, {0x01, 0x02, 0x01, 0x00}, "ADD ECX, IMM", 4);
	addInst(r, {0x01, 0x02, 0x01, 0x01}, "ADD ECX, EAX", 0);
	addInst(r, {0x01, 0x02, 0x01, 0x02}, "ADD ECX, EBX", 0);
	addInst(r, {0x01, 0x02, 0x01, 0x03}, "ADD ECX, EDX", 0);
	addInst(r, {0x01, 0x02, 0x01, 0x04}, "ADD ECX, EEX", 0);

	// ADD EDX, ...
	addInst(r, {0x01, 0x03, 0x01, 0x00}, "ADD EDX, IMM", 4);
	addInst(r, {0x01, 0x03, 0x01, 0x01}, "ADD EDX, EAX", 0);
	addInst(r, {0x01, 0x03, 0x01, 0x02}, "ADD EDX, EBX", 0);
	addInst(r, {0x01, 0x03, 0x01, 0x03}, "ADD EDX, ECX", 0);
	addInst(r, {0x01, 0x03, 0x01, 0x04}, "ADD EDX, EEX", 0);

	// ADD EEX, ...
	addInst(r, {0x01, 0x04, 0x01, 0x00}, "ADD EEX, IMM", 4);
	addInst(r, {0x01, 0x04, 0x01, 0x01}, "ADD EEX, EAX", 0);
	addInst(r, {0x01, 0x04, 0x01, 0x02}, "ADD EEX, EBX", 0);
	addInst(r, {0x01, 0x04, 0x01, 0x03}, "ADD EEX, ECX", 0);
	addInst(r, {0x01, 0x04, 0x01, 0x04}, "ADD EEX, EDX", 0);

	// DEC系
	addInst(r, {0x02, 0x00, 0x00}, "DEC EAX", 0);
	addInst(r, {0x02, 0x00, 0x01}, "DEC EBX", 0);
	addInst(r, {0x02, 0x00, 0x02}, "DEC [EBX]", 0);
	addInst(r, {0x02, 0x00, 0x03}, "DEC ECX", 0);
	addInst(r, {0x02, 0x00, 0x04}, "DEC EDX", 0);
	addInst(r, {0x02, 0x00, 0x05}, "DEC EEX", 0);
	addInst(r, {0x02, 0x00, 0x06}, "DEC EDI", 0);

	// SUB系
	// SUB EAX, ...
	addInst(r, {0x02, 0x01, 0x00, 0x00}, "SUB EAX, IMM", 4);
	addInst(r, {0x02, 0x01, 0x00, 0x01}, "SUB EAX, EBX", 0);
	addInst(r, {0x02, 0x01, 0x00, 0x02}, "SUB EAX, ECX", 0);
	addInst(r, {0x02, 0x01, 0x00, 0x03}, "SUB EAX, EDX", 0);
	addInst(r, {0x02, 0x01, 0x00, 0x04}, "SUB EAX, EEX", 0);

	// SUB EBX, ...
	addInst(r, {0x02, 0x01, 0x01, 0x00}, "SUB EBX, IMM", 4);
	addInst(r, {0x02, 0x01, 0x01, 0x01}, "SUB EBX, EAX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x02}, "SUB EBX, ECX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x03}, "SUB EBX, EDX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x04}, "SUB EBX, EEX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x05}, "SUB [EBX], IMM", 4);
	addInst(r, {0x02, 0x01, 0x01, 0x06}, "SUB [EBX], EAX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x07}, "SUB [EBX], ECX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x08}, "SUB [EBX], EDX", 0);
	addInst(r, {0x02, 0x01, 0x01, 0x09}, "SUB [EBX], EEX", 0);

	// SUB ECX, ...
	addInst(r, {0x02, 0x02, 0x01, 0x00}, "SUB ECX, IMM", 4);
	addInst(r, {0x02, 0x02, 0x01, 0x01}, "SUB ECX, EAX", 0);
	addInst(r, {0x02, 0x02, 0x01, 0x02}, "SUB ECX, EBX", 0);
	addInst(r, {0x02, 0x02, 0x01, 0x03}, "SUB ECX, EDX", 0);
	addInst(r, {0x02, 0x02, 0x01, 0x04}, "SUB ECX, EEX", 0);

	// SUB EDX, ...
	addInst(r, {0x02, 0x03, 0x01, 0x00}, "SUB EDX, IMM", 4);
	addInst(r, {0x02, 0x03, 0x01, 0x01}, "SUB EDX, EAX", 0);
	addInst(r, {0x02, 0x03, 0x01, 0x02}, "SUB EDX, EBX", 0);
	addInst(r, {0x02, 0x03, 0x01, 0x03}, "SUB EDX, ECX", 0);
	addInst(r, {0x02, 0x03, 0x01, 0x04}, "SUB EDX, EEX", 0);

	// SUB EEX, ...
	addInst(r, {0x02, 0x04, 0x01, 0x00}, "SUB EEX, IMM", 4);
	addInst(r, {0x02, 0x04, 0x01, 0x01}, "SUB EEX, EAX", 0);
	addInst(r, {0x02, 0x04, 0x01, 0x02}, "SUB EEX, EBX", 0);
	addInst(r, {0x02, 0x04, 0x01, 0x03}, "SUB EEX, ECX", 0);
	addInst(r, {0x02, 0x04, 0x01, 0x04}, "SUB EEX, EDX", 0);

	// LD系
	// LD EAX, ...
	addInst(r, {0x03, 0x00, 0x00}, "LD EAX, IMM", 4);
	addInst(r, {0x03, 0x00, 0x01}, "LD EAX, EBX", 0);
	addInst(r, {0x03, 0x00, 0x02}, "LD EAX, ECX", 0);
	addInst(r, {0x03, 0x00, 0x03}, "LD EAX, EDX", 0);
	addInst(r, {0x03, 0x00, 0x04}, "LD EAX, EEX", 0);
	addInst(r, {0x03, 0x00, 0x05}, "LD EAX, [IMM]", 4);
	addInst(r, {0x03, 0x00, 0x06}, "LD EAX, [EBX]", 0);
	addInst(r, {0x03, 0x00, 0x07}, "LD EAX, [EDI]", 0);
	addInst(r, {0x03, 0x00, 0x08}, "LD EAX, [ESI]", 0);
	addInst(r, {0x03, 0x00, 0x09}, "LD EAX, [EBP]", 0);
	addInst(r, {0x03, 0x00, 0x0A}, "LD [EAX], IMM", 4);
	addInst(r, {0x03, 0x00, 0x0B}, "LD [EAX], EBX", 0);
	addInst(r, {0x03, 0x00, 0x0C}, "LD [EAX], ECX", 0);
	addInst(r, {0x03, 0x00, 0x0D}, "LD [EAX], EDX", 0);
	addInst(r, {0x03, 0x00, 0x0E}, "LD [EAX], EEX", 0);
	addInst(r, {0x03, 0x00, 0x0F}, "LD [EAX], EDI", 0);
	addInst(r, {0x03, 0x00, 0x10}, "LD [EAX], EBP", 0);

	// LD EBX, ...
	addInst(r, {0x03, 0x01, 0x00}, "LD EBX, IMM", 4);
	addInst(r, {0x03, 0x01, 0x01}, "LD EBX, EAX", 0);
	addInst(r, {0x03, 0x01, 0x02}, "LD EBX, ECX", 0);
	addInst(r, {0x03, 0x01, 0x03}, "LD EBX, EDX", 0);
	addInst(r, {0x03, 0x01, 0x04}, "LD EBX, EEX", 0);
	addInst(r, {0x03, 0x01, 0x05}, "LD EBX, [IMM]", 4);
	addInst(r, {0x03, 0x01, 0x06}, "LD EBX, [EDI]", 0);
	addInst(r, {0x03, 0x01, 0x07}, "LD EBX, [ESI]", 0);
	addInst(r, {0x03, 0x01, 0x08}, "LD EBX, [EBP]", 0);
	addInst(r, {0x03, 0x01, 0x09}, "LD [EBX], IMM", 4);
	addInst(r, {0x03, 0x01, 0x0A}, "LD [EBX], EAX", 0);
	addInst(r, {0x03, 0x01, 0x0B}, "LD [EBX], ECX", 0);
	addInst(r, {0x03, 0x01, 0x0C}, "LD [EBX], EDX", 0);
	addInst(r, {0x03, 0x01, 0x0D}, "LD [EBX], EEX", 0);
	addInst(r, {0x03, 0x01, 0x0E}, "LD [EBX], EDI", 0);
	addInst(r, {0x03, 0x01, 0x0F}, "LD [EBX], ESI", 0);
	addInst(r, {0x03, 0x01, 0x10}, "LD [EBX], EBP", 0);

	// LD ECX, ...
	addInst(r, {0x03, 0x02, 0x00}, "LD ECX, IMM", 4);
	addInst(r, {0x03, 0x02, 0x01}, "LD ECX, EAX", 0);
	addInst(r, {0x03, 0x02, 0x02}, "LD ECX, EBX", 0);
	addInst(r, {0x03, 0x02, 0x03}, "LD ECX, EDX", 0);
	addInst(r, {0x03, 0x02, 0x04}, "LD ECX, EEX", 0);

	// LD EDX, ...
	addInst(r, {0x03, 0x03, 0x00}, "LD EDX, IMM", 4);
	addInst(r, {0x03, 0x03, 0x01}, "LD EDX, EAX", 0);
	addInst(r, {0x03, 0x03, 0x02}, "LD EDX, EBX", 0);
	addInst(r, {0x03, 0x03, 0x03}, "LD EDX, ECX", 0);
	addInst(r, {0x03, 0x03, 0x04}, "LD EDX, EEX", 0);

	// LD EEX, ...
	addInst(r, {0x03, 0x04, 0x00}, "LD EEX, IMM", 4);
	addInst(r, {0x03, 0x04, 0x01}, "LD EEX, EAX", 0);
	addInst(r, {0x03, 0x04, 0x02}, "LD EEX, EBX", 0);
	addInst(r, {0x03, 0x04, 0x03}, "LD EEX, ECX", 0);
	addInst(r, {0x03, 0x04, 0x04}, "LD EEX, EDX", 0);

	// LD EDI, ...
	addInst(r, {0x03, 0x05, 0x00}, "LD EDI, IMM", 4);
	addInst(r, {0x03, 0x05, 0x01}, "LD EDI, EAX", 0);
	addInst(r, {0x03, 0x05, 0x02}, "LD EDI, EBX", 0);
	addInst(r, {0x03, 0x05, 0x03}, "LD EDI, ECX", 0);
	addInst(r, {0x03, 0x05, 0x04}, "LD EDI, EDX", 0);
	addInst(r, {0x03, 0x05, 0x05}, "LD EDI, EEX", 0);
	addInst(r, {0x03, 0x05, 0x06}, "LD EDI, [IMM]", 4);
	addInst(r, {0x03, 0x05, 0x07}, "LD EDI, [EBX]", 0);
	addInst(r, {0x03, 0x05, 0x08}, "LD EDI, [ESI]", 0);
	addInst(r, {0x03, 0x05, 0x09}, "LD EDI, [EBP]", 0);
	addInst(r, {0x03, 0x05, 0x0A}, "LD [EDI], IMM", 4);
	addInst(r, {0x03, 0x05, 0x0B}, "LD [EDI], EAX", 0);
	addInst(r, {0x03, 0x05, 0x0C}, "LD [EDI], EDX", 0);
	addInst(r, {0x03, 0x05, 0x0D}, "LD [EDI], ESI", 0);

	// LD ESI, ...
	addInst(r, {0x03, 0x06, 0x00}, "LD ESI, IMM", 4);
	addInst(r, {0x03, 0x06, 0x01}, "LD ESI, EAX", 0);
	addInst(r, {0x03, 0x06, 0x02}, "LD ESI, EBX", 0);
	addInst(r, {0x03, 0x06, 0x03}, "LD ESI, ECX", 0);
	addInst(r, {0x03, 0x06, 0x04}, "LD ESI, EDX", 0);
	addInst(r, {0x03, 0x06, 0x05}, "LD ESI, EEX", 0);
	addInst(r, {0x03, 0x06, 0x06}, "LD ESI, [IMM]", 4);
	addInst(r, {0x03, 0x06, 0x07}, "LD ESI, [EBX]", 0);
	addInst(r, {0x03, 0x06, 0x08}, "LD ESI, [EDI]", 0);
	addInst(r, {0x03, 0x06, 0x09}, "LD ESI, [EBP]", 0);
	addInst(r, {0x03, 0x06, 0x0A}, "LD [ESI], IMM", 4);
	addInst(r, {0x03, 0x06, 0x0B}, "LD [ESI], EAX", 0);
	addInst(r, {0x03, 0x06, 0x0C}, "LD [ESI], EDX", 0);
	addInst(r, {0x03, 0x06, 0x0D}, "LD [ESI], EDI", 0);

	// LD EBP, ...
	addInst(r, {0x03, 0x07, 0x00}, "LD EBP, IMM", 4);
	addInst(r, {0x03, 0x07, 0x01}, "LD EBP, EAX", 0);
	addInst(r, {0x03, 0x07, 0x02}, "LD EBP, EBX", 0);
	addInst(r, {0x03, 0x07, 0x03}, "LD EBP, ECX", 0);
	addInst(r, {0x03, 0x07, 0x04}, "LD EBP, EDX", 0);
	addInst(r, {0x03, 0x07, 0x05}, "LD EBP, EEX", 0);
	addInst(r, {0x03, 0x07, 0x06}, "LD EBP, [IMM]", 4);
	addInst(r, {0x03, 0x07, 0x07}, "LD EBP, [EBX]", 0);
	addInst(r, {0x03, 0x07, 0x08}, "LD EBP, [EDI]", 0);
	addInst(r, {0x03, 0x07, 0x09}, "LD EBP, [ESI]", 0);
	addInst(r, {0x03, 0x07, 0x0A}, "LD [EBP], IMM", 4);
	addInst(r, {0x03, 0x07, 0x0B}, "LD [EBP], EAX", 0);
	addInst(r, {0x03, 0x07, 0x0C}, "LD [EBP], EDX", 0);

	// CALL系
	addInst(r, {0x0C, 0x00}, "CALL EAX", 0);
	addInst(r, {0x0C, 0x01}, "CALL EBX", 0);
	addInst(r, {0x0C, 0x02}, "CALL ECX", 0);
	addInst(r, {0x0C, 0x03}, "CALL EDX", 0);
	addInst(r, {0x0C, 0x04}, "CALL EEX", 0);

	// RET, HALT
	addInst(r, {0x0E}, "RET", 0);
	addInst(r, {0x0F}, "HALT", 0);

	return true;
}

#endif
